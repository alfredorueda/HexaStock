@startuml sell-error-sell-more-than-owned
!theme plain
skinparam backgroundColor #FEFEFE

actor Client
participant "PortfolioRestController" as Controller
participant "PortfolioStockOperationsService" as Service
participant "Portfolio" as Portfolio
participant "Holding" as Holding
participant "GlobalExceptionHandler" as Handler

Client -> Controller: POST /api/portfolios/abc-123/sales\n{"ticker":"AAPL", "quantity":100}
activate Controller

Controller -> Service: sellStock("abc-123", ticker, 100)
activate Service

Service -> Service: fetch portfolio\n(owns 10 AAPL shares)
Service -> Service: fetch price

Service -> Portfolio: sell(ticker, 100, price)
activate Portfolio

Portfolio -> Portfolio: validate quantity > 0 ✓
Portfolio -> Portfolio: check holdings exist ✓

Portfolio -> Holding: sell(100, price)
activate Holding

Holding -> Holding: check getTotalShares() < quantity
note right of Holding
  Business rule:
  Cannot sell more
  shares than owned
  
  getTotalShares() = 10
  quantity = 100
  10 < 100 → FAIL
end note

Holding -> Holding: if (getTotalShares() < quantity)\n  throw ConflictQuantityException()

Holding --> Portfolio: throw ConflictQuantityException("Not enough shares to sell")
deactivate Holding

Portfolio --> Service: throw ConflictQuantityException
deactivate Portfolio

Service --> Controller: throw ConflictQuantityException
deactivate Service

Controller -> Handler: handle exception
activate Handler

Handler -> Handler: create ProblemDetail:\n- status: 409\n- title: "Conflict Quantity"\n- detail: "Not enough shares to sell"

Handler --> Controller: ResponseEntity<ProblemDetail>
deactivate Handler

Controller --> Client: HTTP 409 CONFLICT\n{\n  "title": "Conflict Quantity",\n  "detail": "Not enough shares to sell",\n  "status": 409\n}
deactivate Controller

note over Client, Handler
  **Domain Exception → HTTP Status**
  ConflictQuantityException → 409 Conflict
  
  The Holding entity protects this invariant.
  The aggregate root delegates the check.
end note

@enduml
