@startuml "HexaStock Domain Model"

' Style definitions
skinparam classAttributeIconSize 0
skinparam class {
  BackgroundColor White
  BorderColor Black
  ArrowColor Black
}

' Packages
package "cat.gencat.agaur.hexastock.model" as model {

  ' Core Entities
  class Portfolio {
    -id: PortfolioId
    -ownerName: String
    -balance: Money
    -createdAt: LocalDateTime
    -holdings: Map<Ticker, Holding>
    +{static} create(ownerName: String): Portfolio
    +deposit(money: Money): void
    +withdraw(money: Money): void
    +buy(ticker: Ticker, quantity: ShareQuantity, price: Price): void
    +sell(ticker: Ticker, quantity: ShareQuantity, price: Price): SellResult
    +getHoldings(): List<Holding>
    +getHolding(ticker: Ticker): Holding
    +addHolding(holding: Holding): void
    +getId(): PortfolioId
    +getOwnerName(): String
    +getBalance(): Money
    +getCreatedAt(): LocalDateTime
  }

  class Holding {
    -id: HoldingId
    -ticker: Ticker
    -lots: List<Lot>
    +{static} create(ticker: Ticker): Holding
    +buy(quantity: ShareQuantity, unitPrice: Price): void
    +sell(quantity: ShareQuantity, sellPrice: Price): SellResult
    +getTotalShares(): ShareQuantity
    +getRemainingSharesPurchasePrice(): Money
    +getTheoreticSalePrice(currentPrice: Price): Money
    +getUnrealizedGain(currentPrice: Price): Money
    +addLot(lot: Lot): void
    +getId(): HoldingId
    +getTicker(): Ticker
    +getLots(): List<Lot>
  }

  class Lot {
    -id: LotId
    -initialShares: ShareQuantity
    -remainingShares: ShareQuantity
    -unitPrice: Price
    -purchasedAt: LocalDateTime
    +{static} create(quantity: ShareQuantity, unitPrice: Price): Lot
    +reduce(quantity: ShareQuantity): void
    +calculateCostBasis(quantity: ShareQuantity): Money
    +isEmpty(): boolean
    +getId(): LotId
    +getInitialShares(): ShareQuantity
    +getRemainingShares(): ShareQuantity
    +getUnitPrice(): Price
    +getPurchasedAt(): LocalDateTime
  }

  class Transaction {
    -id: TransactionId
    -portfolioId: PortfolioId
    -type: TransactionType
    -ticker: Ticker
    -quantity: ShareQuantity
    -unitPrice: Price
    -totalAmount: Money
    -profit: Money
    -createdAt: LocalDateTime
    +{static} createDeposit(portfolioId: PortfolioId, amount: Money): Transaction
    +{static} createWithdrawal(portfolioId: PortfolioId, amount: Money): Transaction
    +{static} createPurchase(portfolioId: PortfolioId, ticker: Ticker, quantity: ShareQuantity, unitPrice: Price): Transaction
    +{static} createSale(portfolioId: PortfolioId, ticker: Ticker, quantity: ShareQuantity, unitPrice: Price, totalAmount: Money, profit: Money): Transaction
    +getId(): TransactionId
    +getPortfolioId(): PortfolioId
    +getType(): TransactionType
    +getTicker(): Ticker
    +getQuantity(): ShareQuantity
    +getUnitPrice(): Price
    +getTotalAmount(): Money
    +getProfit(): Money
    +getCreatedAt(): LocalDateTime
  }

  ' Value Objects
  class Money <<record>> {
    -amount: BigDecimal
    +{static} ZERO: Money
    +{static} of(value: BigDecimal): Money
    +{static} of(value: double): Money
    +{static} of(value: String): Money
    +{static} of(dollars: int, cents: int): Money
    +add(augend: Money): Money
    +subtract(subtrahend: Money): Money
    +multiply(multiplicand: int): Money
    +multiply(quantity: ShareQuantity): Money
    +negate(): Money
    +isPositive(): boolean
    +isNegative(): boolean
    +isZero(): boolean
    +isGreaterThanOrEqual(other: Money): boolean
    +isLessThan(other: Money): boolean
  }

  class Price <<record>> {
    -value: BigDecimal
    +{static} of(value: BigDecimal): Price
    +{static} of(value: double): Price
    +{static} of(value: String): Price
    +multiply(quantity: ShareQuantity): Money
    +toMoney(): Money
  }

  class ShareQuantity <<record>> {
    -value: int
    +{static} ZERO: ShareQuantity
    +{static} of(value: int): ShareQuantity
    +{static} positive(value: int): ShareQuantity
    +add(other: ShareQuantity): ShareQuantity
    +subtract(other: ShareQuantity): ShareQuantity
    +min(other: ShareQuantity): ShareQuantity
    +isZero(): boolean
    +isPositive(): boolean
    +isGreaterThanOrEqual(other: ShareQuantity): boolean
    +isLessThanOrEqual(other: ShareQuantity): boolean
  }

  class Ticker <<record>> {
    -value: String
    +{static} of(value: String): Ticker
  }

  class SellResult <<record>> {
    -proceeds: Money
    -costBasis: Money
    -profit: Money
    +{static} of(proceeds: Money, costBasis: Money): SellResult
    +isProfitable(): boolean
    +isLoss(): boolean
  }

  class StockPrice <<record>> {
    -ticker: Ticker
    -price: Price
    -time: Instant
    +{static} of(ticker: Ticker, price: Price, time: Instant): StockPrice
  }

  class PortfolioId <<record>> {
    -value: String
    +{static} of(value: String): PortfolioId
    +{static} generate(): PortfolioId
  }

  class HoldingId <<record>> {
    -value: String
    +{static} of(value: String): HoldingId
    +{static} generate(): HoldingId
  }

  class LotId <<record>> {
    -value: String
    +{static} of(value: String): LotId
    +{static} generate(): LotId
  }

  class TransactionId <<record>> {
    -value: String
    +{static} of(value: String): TransactionId
    +{static} generate(): TransactionId
  }

  enum TransactionType {
    DEPOSIT
    WITHDRAWAL
    PURCHASE
    SALE
  }

  ' Domain Services
  class HoldingPerformanceCalculator {
    +getHoldingsPerfomance(portfolio: Portfolio, lTransactions: List<Transaction>, mTickerPrices: Map<Ticker, StockPrice>): List<HoldingDTO>
  }
}

' Exceptions package
package "cat.gencat.agaur.hexastock.model.exception" as exceptions {
  abstract class DomainException {
  }

  class InvalidAmountException extends DomainException {
  }

  class InvalidQuantityException extends DomainException {
  }

  class InsufficientFundsException extends DomainException {
  }

  class PortfolioNotFoundException extends DomainException {
  }

  class ConflictQuantityException extends DomainException {
  }

  class HoldingNotFoundException extends DomainException {
  }

  class EntityExistsException extends DomainException {
  }
}

' Relationships — Entities
Portfolio "1" *--> "0..*" Holding : contains
Holding "1" *--> "0..*" Lot : contains

' Relationships — Value Object usage by Entities
Portfolio --> PortfolioId : identified by
Portfolio --> Money : balance
Portfolio --> Ticker : keys holdings
Portfolio ..> SellResult : returns
Portfolio ..> Price : uses
Portfolio ..> ShareQuantity : uses

Holding --> HoldingId : identified by
Holding --> Ticker : identifies
Holding ..> SellResult : returns
Holding ..> ShareQuantity : uses
Holding ..> Price : uses
Holding ..> Money : uses

Lot --> LotId : identified by
Lot --> ShareQuantity : initialShares, remainingShares
Lot --> Price : unitPrice
Lot ..> Money : returns

Transaction --> TransactionId : identified by
Transaction --> PortfolioId : references
Transaction --> TransactionType : has
Transaction --> Ticker : references
Transaction --> ShareQuantity : quantity
Transaction --> Price : unitPrice
Transaction --> Money : totalAmount, profit

StockPrice --> Ticker : for
StockPrice --> Price : contains

Price ..> Money : multiply() returns

HoldingPerformanceCalculator ..> Portfolio : uses
HoldingPerformanceCalculator ..> Transaction : uses
HoldingPerformanceCalculator ..> StockPrice : uses

@enduml