@startuml sell-error-invalid-quantity
!theme plain
skinparam backgroundColor #FEFEFE

actor Client
participant "PortfolioRestController" as Controller
participant "PortfolioStockOperationsService" as Service
participant "Portfolio" as Portfolio
participant "GlobalExceptionHandler" as Handler

Client -> Controller: POST /api/portfolios/abc-123/sales\n{"ticker":"AAPL", "quantity":0}
activate Controller

Controller -> Controller: Create Value Objects:\nPortfolioId.of("abc-123")\nTicker.of("AAPL")\nShareQuantity.positive(0)

note right of Controller
  **Defense in depth:**
  ShareQuantity.positive(0)
  throws InvalidQuantityException
  at the adapter boundary.
  
  Even if bypassed, Portfolio.sell()
  checks quantity.isPositive() again.
end note

Controller --> Controller: throw InvalidQuantityException(\n"Quantity must be positive: 0")

Controller -> Handler: handle exception
activate Handler

Handler -> Handler: create ProblemDetail:\n- status: 400\n- title: "Invalid Quantity"\n- detail: "Quantity must be positive"

Handler --> Controller: ResponseEntity<ProblemDetail>
deactivate Handler

Controller --> Client: HTTP 400 BAD REQUEST\n{\n  "title": "Invalid Quantity",\n  "detail": "Quantity must be positive",\n  "status": 400\n}
deactivate Controller

note over Client, Handler
  **Domain Exception → HTTP Status**
  InvalidQuantityException → 400 Bad Request
  
  The Value Object **ShareQuantity.positive()**
  enforces this rule at construction time.
  Portfolio.sell() provides a second guard.
end note
@enduml
