<?plantuml 1.2026.1?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="SEQUENCE" height="1507px" preserveAspectRatio="none" style="width:1427px;height:1507px;background:#FEFEFE;" version="1.1" viewBox="0 0 1427 1507" width="1427px" zoomAndPan="magnify"><defs/><g><rect fill="#FEFEFE" height="1507" style="stroke:none;stroke-width:1;" width="1427" x="0" y="0"/><g><title>Portfolio</title><rect fill="#FFFFFF" height="1199.4375" style="stroke:#000000;stroke-width:1;" width="10" x="100.5049" y="95.1875"/></g><g><title>Holding</title><rect fill="#FFFFFF" height="1007.6406" style="stroke:#000000;stroke-width:1;" width="10" x="405.8291" y="200.5859"/></g><g><title>Lot 1</title><rect fill="#FFFFFF" height="91.0547" style="stroke:#000000;stroke-width:1;" width="10" x="842.0767" y="499.4922"/></g><g><title>Lot 1</title><rect fill="#FFFFFF" height="128.5313" style="stroke:#000000;stroke-width:1;" width="10" x="842.0767" y="681.6016"/></g><g class="participant-lifeline" data-entity-uid="part1" data-qualified-name="Portfolio" id="part1-lifeline"><g><title>Portfolio</title><rect fill="#000000" fill-opacity="0.00000" height="1338.2344" width="8" x="101.5049" y="85.1875"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:5,5;" x1="105" x2="105" y1="85.1875" y2="1423.4219"/></g></g><g class="participant-lifeline" data-entity-uid="part2" data-qualified-name="Holding" id="part2-lifeline"><g><title>Holding</title><rect fill="#000000" fill-opacity="0.00000" height="1338.2344" width="8" x="406.8291" y="85.1875"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:5,5;" x1="410.0698" x2="410.0698" y1="85.1875" y2="1423.4219"/></g></g><g class="participant-lifeline" data-entity-uid="part3" data-qualified-name="Lot1" id="part3-lifeline"><g><title>Lot 1</title><rect fill="#000000" fill-opacity="0.00000" height="1338.2344" width="8" x="843.0767" y="85.1875"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:5,5;" x1="847.0361" x2="847.0361" y1="85.1875" y2="1423.4219"/></g></g><g class="participant-lifeline" data-entity-uid="part4" data-qualified-name="Lot2" id="part4-lifeline"><g><title>Lot 2</title><rect fill="#000000" fill-opacity="0.00000" height="1338.2344" width="8" x="1297.8184" y="85.1875"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:5,5;" x1="1301.2314" x2="1301.2314" y1="85.1875" y2="1423.4219"/></g></g><g class="participant participant-head" data-entity-uid="part1" data-qualified-name="Portfolio" id="part1-head"><rect fill="#FFFFFF" height="46.5938" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="135.0098" x="38" y="37.5938"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="58.0918" x="76.459" y="57.5889">Portfolio</text><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="121.0098" x="45" y="73.8857">(Aggregate Root)</text></g><g class="participant participant-tail" data-entity-uid="part1" data-qualified-name="Portfolio" id="part1-tail"><rect fill="#FFFFFF" height="46.5938" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="135.0098" x="38" y="1422.4219"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="58.0918" x="76.459" y="1442.417">Portfolio</text><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="121.0098" x="45" y="1458.7139">(Aggregate Root)</text></g><g class="participant participant-head" data-entity-uid="part2" data-qualified-name="Holding" id="part2-head"><rect fill="#FFFFFF" height="46.5938" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="67.5186" x="377.0698" y="37.5938"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="53.5186" x="384.0698" y="57.5889">Holding</text><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="51.7959" x="384.9312" y="73.8857">(Entity)</text></g><g class="participant participant-tail" data-entity-uid="part2" data-qualified-name="Holding" id="part2-tail"><rect fill="#FFFFFF" height="46.5938" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="67.5186" x="377.0698" y="1422.4219"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="53.5186" x="384.0698" y="1442.417">Holding</text><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="51.7959" x="384.9312" y="1458.7139">(Entity)</text></g><g class="participant participant-head" data-entity-uid="part3" data-qualified-name="Lot1" id="part3-head"><rect fill="#FFFFFF" height="79.1875" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="228.0811" x="733.0361" y="5"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="35.2119" x="829.4707" y="24.9951">Lot 1</text><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="51.7959" x="821.1787" y="41.292">(Entity)</text><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="163.543" x="765.3052" y="57.5889">Purchased: 2024-01-15</text><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="214.0811" x="740.0361" y="73.8857">Remaining: ShareQuantity(10)</text></g><g class="participant participant-tail" data-entity-uid="part3" data-qualified-name="Lot1" id="part3-tail"><rect fill="#FFFFFF" height="79.1875" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="228.0811" x="733.0361" y="1422.4219"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="35.2119" x="829.4707" y="1442.417">Lot 1</text><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="51.7959" x="821.1787" y="1458.7139">(Entity)</text><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="163.543" x="765.3052" y="1475.0107">Purchased: 2024-01-15</text><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="214.0811" x="740.0361" y="1491.3076">Remaining: ShareQuantity(10)</text></g><g class="participant participant-head" data-entity-uid="part4" data-qualified-name="Lot2" id="part4-head"><rect fill="#FFFFFF" height="79.1875" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="219.1738" x="1192.2314" y="5"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="35.2119" x="1284.2124" y="24.9951">Lot 2</text><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="51.7959" x="1275.9204" y="41.292">(Entity)</text><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="163.543" x="1220.0469" y="57.5889">Purchased: 2024-02-20</text><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="205.1738" x="1199.2314" y="73.8857">Remaining: ShareQuantity(5)</text></g><g class="participant participant-tail" data-entity-uid="part4" data-qualified-name="Lot2" id="part4-tail"><rect fill="#FFFFFF" height="79.1875" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="219.1738" x="1192.2314" y="1422.4219"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="35.2119" x="1284.2124" y="1442.417">Lot 2</text><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="51.7959" x="1275.9204" y="1458.7139">(Entity)</text><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="163.543" x="1220.0469" y="1475.0107">Purchased: 2024-02-20</text><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="205.1738" x="1199.2314" y="1491.3076">Remaining: ShareQuantity(5)</text></g><g><title>Portfolio</title><rect fill="#FFFFFF" height="1199.4375" style="stroke:#000000;stroke-width:1;" width="10" x="100.5049" y="95.1875"/></g><g><title>Holding</title><rect fill="#FFFFFF" height="1007.6406" style="stroke:#000000;stroke-width:1;" width="10" x="405.8291" y="200.5859"/></g><g><title>Lot 1</title><rect fill="#FFFFFF" height="91.0547" style="stroke:#000000;stroke-width:1;" width="10" x="842.0767" y="499.4922"/></g><g><title>Lot 1</title><rect fill="#FFFFFF" height="128.5313" style="stroke:#000000;stroke-width:1;" width="10" x="842.0767" y="681.6016"/></g><g class="message" data-entity-1="part1" data-entity-2="part1" id="msg1"><line style="stroke:#000000;stroke-width:1;" x1="110.5049" x2="152.5049" y1="116.3203" y2="116.3203"/><line style="stroke:#000000;stroke-width:1;" x1="152.5049" x2="152.5049" y1="116.3203" y2="129.3203"/><line style="stroke:#000000;stroke-width:1;" x1="111.5049" x2="152.5049" y1="129.3203" y2="129.3203"/><polygon fill="#000000" points="121.5049,125.3203,111.5049,129.3203,121.5049,133.3203,117.5049,129.3203" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="185.7642" x="117.5049" y="111.2544">validate quantity.isPositive()</text></g><g class="message" data-entity-1="part1" data-entity-2="part1" id="msg2"><line style="stroke:#000000;stroke-width:1;" x1="110.5049" x2="152.5049" y1="158.4531" y2="158.4531"/><line style="stroke:#000000;stroke-width:1;" x1="152.5049" x2="152.5049" y1="158.4531" y2="171.4531"/><line style="stroke:#000000;stroke-width:1;" x1="111.5049" x2="152.5049" y1="171.4531" y2="171.4531"/><polygon fill="#000000" points="121.5049,167.4531,111.5049,171.4531,121.5049,175.4531,117.5049,171.4531" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="227.373" x="117.5049" y="153.3872">check holdings.containsKey(ticker)</text></g><g class="message" data-entity-1="part1" data-entity-2="part2" id="msg3"><polygon fill="#000000" points="393.8291,196.5859,403.8291,200.5859,393.8291,204.5859,397.8291,200.5859" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="110.5049" x2="399.8291" y1="200.5859" y2="200.5859"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="219.6924" x="117.5049" y="195.52">sell(ShareQuantity(7), Price(150))</text></g><g class="message" data-entity-1="part2" data-entity-2="part2" id="msg4"><line style="stroke:#000000;stroke-width:1;" x1="415.8291" x2="457.8291" y1="241.3516" y2="241.3516"/><line style="stroke:#000000;stroke-width:1;" x1="457.8291" x2="457.8291" y1="241.3516" y2="254.3516"/><line style="stroke:#000000;stroke-width:1;" x1="416.8291" x2="457.8291" y1="254.3516" y2="254.3516"/><polygon fill="#000000" points="426.8291,250.3516,416.8291,254.3516,426.8291,258.3516,422.8291,254.3516" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="238.9321" x="422.8291" y="236.2856">check getTotalShares().value() &gt;= 7</text></g><path d="M682.9321,213.5859 L682.9321,268.5859 L1079.9321,268.5859 L1079.9321,223.5859 L1069.9321,213.5859 L682.9321,213.5859" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M1069.9321,213.5859 L1069.9321,223.5859 L1079.9321,223.5859 L1069.9321,213.5859" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="376.2192" x="688.9321" y="230.6528">Total: ShareQuantity(10) + ShareQuantity(5) = 15 shares</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="164.4805" x="688.9321" y="245.7856">Selling: ShareQuantity(7)</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="93.0186" x="688.9321" y="260.9185">OK to proceed</text><g class="message" data-entity-1="part2" data-entity-2="part2" id="msg6"><line style="stroke:#000000;stroke-width:1;" x1="415.8291" x2="457.8291" y1="310.25" y2="310.25"/><line style="stroke:#000000;stroke-width:1;" x1="457.8291" x2="457.8291" y1="310.25" y2="323.25"/><line style="stroke:#000000;stroke-width:1;" x1="416.8291" x2="457.8291" y1="323.25" y2="323.25"/><polygon fill="#000000" points="426.8291,319.25,416.8291,323.25,426.8291,327.25,422.8291,323.25" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="236.8438" x="422.8291" y="290.0513">remainingToSell = ShareQuantity(7)</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="163.7886" x="422.8291" y="305.1841">costBasis = Money.ZERO</text></g><path d="M324,336.25 L324,376.25 L497,376.25 L497,346.25 L487,336.25 L324,336.25" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M487,336.25 L487,346.25 L497,346.25 L487,336.25" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="110.811" x="330" y="353.3169">FIFO Algorithm</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="152.293" x="330" y="368.4497">Sell from oldest lot first</text><g class="message" data-entity-1="part2" data-entity-2="part2" id="msg7"><line style="stroke:#000000;stroke-width:1;" x1="415.8291" x2="457.8291" y1="457.3594" y2="457.3594"/><line style="stroke:#000000;stroke-width:1;" x1="457.8291" x2="457.8291" y1="457.3594" y2="470.3594"/><line style="stroke:#000000;stroke-width:1;" x1="416.8291" x2="457.8291" y1="470.3594" y2="470.3594"/><polygon fill="#000000" points="426.8291,466.3594,416.8291,470.3594,426.8291,474.3594,422.8291,470.3594" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="139.9214" x="422.8291" y="397.5825">sharesSoldFromLot =</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="318.8301" x="422.8291" y="412.7153">lot1.getRemainingShares().min(remainingToSell)</text><text fill="#000000" font-family="Verdana" font-size="17" font-weight="bold" lengthAdjust="spacing" textLength="402.2476" x="422.8291" y="431.561">ShareQuantity(10).min(ShareQuantity(7))</text><text fill="#000000" font-family="Verdana" font-size="17" font-weight="bold" lengthAdjust="spacing" textLength="166.3892" x="422.8291" y="451.3501">ShareQuantity(7)</text></g><g class="message" data-entity-1="part2" data-entity-2="part3" id="msg8"><polygon fill="#000000" points="830.0767,495.4922,840.0767,499.4922,830.0767,503.4922,834.0767,499.4922" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="415.8291" x2="836.0767" y1="499.4922" y2="499.4922"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="244.2642" x="422.8291" y="494.4263">calculateCostBasis(ShareQuantity(7))</text></g><g class="message" data-entity-1="part3" data-entity-2="part3" id="msg9"><line style="stroke:#000000;stroke-width:1;" x1="852.0767" x2="894.0767" y1="548.4141" y2="548.4141"/><line style="stroke:#000000;stroke-width:1;" x1="894.0767" x2="894.0767" y1="548.4141" y2="561.4141"/><line style="stroke:#000000;stroke-width:1;" x1="853.0767" x2="894.0767" y1="561.4141" y2="561.4141"/><polygon fill="#000000" points="863.0767,557.4141,853.0767,561.4141,863.0767,565.4141,859.0767,561.4141" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="236.5771" x="859.0767" y="523.5591">unitPrice.multiply(ShareQuantity(7))</text><text fill="#000000" font-family="Verdana" font-size="17" font-weight="bold" lengthAdjust="spacing" textLength="277.6279" x="859.0767" y="542.4048">Price(100) &#215; 7 = Money(700)</text></g><g class="message" data-entity-1="part3" data-entity-2="part2" id="msg10"><polygon fill="#000000" points="426.8291,586.5469,416.8291,590.5469,426.8291,594.5469,422.8291,590.5469" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="420.8291" x2="846.0767" y1="590.5469" y2="590.5469"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="78.0571" x="432.8291" y="585.481">Money(700)</text></g><g class="message" data-entity-1="part2" data-entity-2="part2" id="msg11"><line style="stroke:#000000;stroke-width:1;" x1="415.8291" x2="457.8291" y1="639.4688" y2="639.4688"/><line style="stroke:#000000;stroke-width:1;" x1="457.8291" x2="457.8291" y1="639.4688" y2="652.4688"/><line style="stroke:#000000;stroke-width:1;" x1="416.8291" x2="457.8291" y1="652.4688" y2="652.4688"/><polygon fill="#000000" points="426.8291,648.4688,416.8291,652.4688,426.8291,656.4688,422.8291,652.4688" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="280.5918" x="422.8291" y="614.6138">costBasis = Money.ZERO.add(Money(700))</text><text fill="#000000" font-family="Verdana" font-size="17" font-weight="bold" lengthAdjust="spacing" textLength="114.335" x="422.8291" y="633.4595">Money(700)</text></g><g class="message" data-entity-1="part2" data-entity-2="part3" id="msg12"><polygon fill="#000000" points="830.0767,677.6016,840.0767,681.6016,830.0767,685.6016,834.0767,681.6016" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="415.8291" x2="836.0767" y1="681.6016" y2="681.6016"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="167.5146" x="422.8291" y="676.5356">reduce(ShareQuantity(7))</text></g><g class="message" data-entity-1="part3" data-entity-2="part3" id="msg13"><line style="stroke:#000000;stroke-width:1;" x1="852.0767" x2="894.0767" y1="710.7344" y2="710.7344"/><line style="stroke:#000000;stroke-width:1;" x1="894.0767" x2="894.0767" y1="710.7344" y2="723.7344"/><line style="stroke:#000000;stroke-width:1;" x1="853.0767" x2="894.0767" y1="723.7344" y2="723.7344"/><polygon fill="#000000" points="863.0767,719.7344,853.0767,723.7344,863.0767,727.7344,859.0767,723.7344" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="217.9214" x="859.0767" y="705.6685">validate qty &lt;= remainingShares</text></g><g class="message" data-entity-1="part3" data-entity-2="part3" id="msg14"><line style="stroke:#000000;stroke-width:1;" x1="852.0767" x2="894.0767" y1="768" y2="768"/><line style="stroke:#000000;stroke-width:1;" x1="894.0767" x2="894.0767" y1="768" y2="781"/><line style="stroke:#000000;stroke-width:1;" x1="853.0767" x2="894.0767" y1="781" y2="781"/><polygon fill="#000000" points="863.0767,777,853.0767,781,863.0767,785,859.0767,781" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="420.7417" x="859.0767" y="747.8013">remainingShares = remainingShares.subtract(ShareQuantity(7))</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="252.2114" x="859.0767" y="762.9341">ShareQuantity(10) &#8594; ShareQuantity(3)</text></g><g class="message" data-entity-1="part3" data-entity-2="part2" id="msg15"><polygon fill="#000000" points="426.8291,806.1328,416.8291,810.1328,426.8291,814.1328,422.8291,810.1328" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="420.8291" x2="846.0767" y1="810.1328" y2="810.1328"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="27.5107" x="432.8291" y="805.0669">void</text></g><g class="message" data-entity-1="part2" data-entity-2="part2" id="msg16"><line style="stroke:#000000;stroke-width:1;" x1="415.8291" x2="457.8291" y1="874.1875" y2="874.1875"/><line style="stroke:#000000;stroke-width:1;" x1="457.8291" x2="457.8291" y1="874.1875" y2="887.1875"/><line style="stroke:#000000;stroke-width:1;" x1="416.8291" x2="457.8291" y1="887.1875" y2="887.1875"/><polygon fill="#000000" points="426.8291,883.1875,416.8291,887.1875,426.8291,891.1875,422.8291,887.1875" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="120.3198" x="422.8291" y="834.1997">remainingToSell =</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="292.9761" x="422.8291" y="849.3325">ShareQuantity(7).subtract(ShareQuantity(7))</text><text fill="#000000" font-family="Verdana" font-size="17" font-weight="bold" lengthAdjust="spacing" textLength="196.9609" x="422.8291" y="868.1782">ShareQuantity.ZERO</text></g><path d="M420,900.1875 L420,940.1875 L646,940.1875 L646,910.1875 L636,900.1875 L420,900.1875" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M636,900.1875 L636,910.1875 L646,910.1875 L636,900.1875" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="205.9941" x="426" y="917.2544">remainingToSell.isZero() &#8594; true</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="162.9634" x="426" y="932.3872">Lot2 remains untouched.</text><g class="message" data-entity-1="part2" data-entity-2="part2" id="msg17"><line style="stroke:#000000;stroke-width:1;" x1="415.8291" x2="457.8291" y1="981.7188" y2="981.7188"/><line style="stroke:#000000;stroke-width:1;" x1="457.8291" x2="457.8291" y1="981.7188" y2="994.7188"/><line style="stroke:#000000;stroke-width:1;" x1="416.8291" x2="457.8291" y1="994.7188" y2="994.7188"/><polygon fill="#000000" points="426.8291,990.7188,416.8291,994.7188,426.8291,998.7188,422.8291,994.7188" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="177.1313" x="422.8291" y="961.52">lots.removeIf(Lot::isEmpty)</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="219.1211" x="422.8291" y="976.6528">(no lots removed, Lot1 still has 3)</text></g><g class="message" data-entity-1="part2" data-entity-2="part2" id="msg18"><line style="stroke:#000000;stroke-width:1;" x1="415.8291" x2="457.8291" y1="1043.6406" y2="1043.6406"/><line style="stroke:#000000;stroke-width:1;" x1="457.8291" x2="457.8291" y1="1043.6406" y2="1056.6406"/><line style="stroke:#000000;stroke-width:1;" x1="416.8291" x2="457.8291" y1="1056.6406" y2="1056.6406"/><polygon fill="#000000" points="426.8291,1052.6406,416.8291,1056.6406,426.8291,1060.6406,422.8291,1056.6406" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="325.2222" x="422.8291" y="1018.7856">proceeds = Price(150).multiply(ShareQuantity(7))</text><text fill="#000000" font-family="Verdana" font-size="17" font-weight="bold" lengthAdjust="spacing" textLength="126.1636" x="422.8291" y="1037.6313">Money(1050)</text></g><g class="message" data-entity-1="part2" data-entity-2="part2" id="msg19"><line style="stroke:#000000;stroke-width:1;" x1="415.8291" x2="457.8291" y1="1120.6953" y2="1120.6953"/><line style="stroke:#000000;stroke-width:1;" x1="457.8291" x2="457.8291" y1="1120.6953" y2="1133.6953"/><line style="stroke:#000000;stroke-width:1;" x1="416.8291" x2="457.8291" y1="1133.6953" y2="1133.6953"/><polygon fill="#000000" points="426.8291,1129.6953,416.8291,1133.6953,426.8291,1137.6953,422.8291,1133.6953" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="263.6816" x="422.8291" y="1080.7075">SellResult.of(Money(1050), Money(700))</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="187.6812" x="422.8291" y="1095.8403">profit = proceeds - costBasis</text><text fill="#000000" font-family="Verdana" font-size="17" font-weight="bold" lengthAdjust="spacing" textLength="399.8071" x="422.8291" y="1114.686">Money(1050) - Money(700) = Money(350)</text></g><g class="message" data-entity-1="part2" data-entity-2="part1" id="msg20"><polygon fill="#000000" points="121.5049,1204.2266,111.5049,1208.2266,121.5049,1212.2266,117.5049,1208.2266" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="115.5049" x2="409.8291" y1="1208.2266" y2="1208.2266"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="69.2974" x="127.5049" y="1157.7622">SellResult(</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="161.0718" x="127.5049" y="1172.895">proceeds=Money(1050),</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="154.0957" x="127.5049" y="1188.0278">costBasis=Money(700),</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="128.8574" x="127.5049" y="1203.1606">profit=Money(350))</text></g><g class="message" data-entity-1="part1" data-entity-2="part1" id="msg21"><line style="stroke:#000000;stroke-width:1;" x1="110.5049" x2="152.5049" y1="1252.4922" y2="1252.4922"/><line style="stroke:#000000;stroke-width:1;" x1="152.5049" x2="152.5049" y1="1252.4922" y2="1265.4922"/><line style="stroke:#000000;stroke-width:1;" x1="111.5049" x2="152.5049" y1="1265.4922" y2="1265.4922"/><polygon fill="#000000" points="121.5049,1261.4922,111.5049,1265.4922,121.5049,1269.4922,117.5049,1265.4922" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="271.3242" x="117.5049" y="1232.2935">balance = balance.add(result.proceeds())</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="167.5591" x="117.5049" y="1247.4263">balance += Money(1050)</text></g><g class="message" data-entity-1="part1" data-entity-2="part1" id="msg22"><polygon fill="#000000" points="1414.4053,1290.625,1424.4053,1294.625,1414.4053,1298.625,1418.4053,1294.625" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="105.5049" x2="1420.4053" y1="1294.625" y2="1294.625"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="64.2256" x="112.5049" y="1289.5591">SellResult</text></g><path d="M10,1307.625 L10,1407.625 L1398,1407.625 L1398,1317.625 L1388,1307.625 L10,1307.625" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M1388,1307.625 L1388,1317.625 L1398,1317.625 L1388,1307.625" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="187.7446" x="501.4526" y="1324.6919">Key Invariants Protected:</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="396.5" x="501.4526" y="1339.8247">1. Cannot sell more than owned (ShareQuantity comparison)</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="194.7334" x="501.4526" y="1354.9575">2. FIFO order strictly enforced</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="266.3159" x="501.4526" y="1370.0903">3. Balance (Money) updated consistently</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="281.7788" x="501.4526" y="1385.2231">4. Lot ShareQuantity remains non-negative</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="253.9888" x="501.4526" y="1400.356">5. Empty lots removed from aggregate</text><?plantuml-src bLPTRjiu47xNAQRjYvJQWkNKC62i2xH1WWswYwH9dmg_C19j4v4uNf9ouGlq0Fko1-fDUf8EALcKP2NP8a0WYpFVVFDnVlJAR7d1OPSp8GFzAEIEALR00qiVDmfBcLrWZWhUN5tQlo2WOoDIiMFImEjRL6QDkS2L33ziDeflcE5mXsYYry0qDETTjpynpuJSaDEbDC8SAkFwRTVqBpIGUCELl2rLkcMQPmkOJgRlnfDadCnMyeuNb02vB-1-onJ_N3Bd4IQJ2fs0abFewRFGq_5qyWpqh46U1W5BZTZRx7tEpHECt_lN2zYpN6JMz9yQAHRw5hKW01v6JxgbMvu-mhPIISSfIaEyz2T-22cfHwwYeEjR2xe0pVCyx7AVHoEuLIBbOJARH96dVxo5e7xe05KKDjnyGSDoXwZ3AAQ4Ic8ExvSm3oGIYXARhGa0dDt0bS3R4orX2SaCjCCaptlYFA3vFAApcqzW47OAKywpWCiCRD1XokfuUr_GGbAKFk1AfgZDHwQ5fjE_KV93_FNoxYQeKi4zLuqg06TdLzTND_0Xtw0IPbkSdTLaOQsm0BBZsa1EjRKMIfiNs5NftjFFA_As5RbSIN9EOXAvARn6w4B8i9SGqL-Uwkii-uaEc9ASRLwsIUYMMPwMEHN3nL6NKoXVCAwnx3yFK4fXN775HPaRiSiFmrpg0fnGFVpu3-P7zSCvlQaXssAr3ZFUZJzShOFN6hCi2psK8z92FfL3yQmachydWUznSu0_bhuCgxliMVTEuSG-rkM3KHHmICZJxlhv_T_UHPyF2Rf7aVq_AK-wg1zr7ZrBiLTtxVvoem9mtUgnNZGQZr-vmh3AowYIausTkhMXfe8pMD9mok8N-erQIyVaHKrzlGu9Ox4G-hBOkVaVIdG6K1ba8oS8Q2CeOreCS1uDezQJoDwRdwalr7vLSibaDda2r6P-npM1nBWEM-OZw5Gl1LyBcXkUnTXNVYyI7NdVfjtEknowMyVJ25qi5sBPfjEQdqkFFZeoM_eWdRvj5irJ--w1vKocd6ZMJwvpLIN9aKbe9JXQlkt9sa8cw7OkRI9-ORS6VlDoLErtE_XfqyArt3Cbw2hfuqQHTMheSy7jW2I62oO9mQrRA51nC5ic0Rz9da6t2kY62leO4HgbNMZJ6DnMGPLHR6seY4n-02xNg59QSG3dCNoiiwng8O9oPmTCHb2If3TSaWjPleijusw_DOqYKOwb_KgZJmsodSNWYhzJzjKYOyVFkQQZVW40?></g></svg>