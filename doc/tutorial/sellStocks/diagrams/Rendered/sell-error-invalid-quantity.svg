<?plantuml 1.2026.1?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="SEQUENCE" height="859px" preserveAspectRatio="none" style="width:1189px;height:859px;background:#FEFEFE;" version="1.1" viewBox="0 0 1189 859" width="1189px" zoomAndPan="magnify"><defs/><g><rect fill="#FEFEFE" height="859" style="stroke:none;stroke-width:1;" width="1189" x="0" y="0"/><g><title>PortfolioRestController</title><rect fill="#FFFFFF" height="521.3203" style="stroke:#000000;stroke-width:1;" width="10" x="343.2168" y="128.5625"/></g><g><title>GlobalExceptionHandler</title><rect fill="#FFFFFF" height="116.6641" style="stroke:#000000;stroke-width:1;" width="10" x="930.6089" y="428.4219"/></g><g class="participant-lifeline" data-entity-uid="part1" data-qualified-name="Client" id="part1-lifeline"><g><title>Client</title><rect fill="#000000" fill-opacity="0.00000" height="696.3828" width="8" x="65.2651" y="82.2969"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:5,5;" x1="69" x2="69" y1="82.2969" y2="778.6797"/></g></g><g class="participant-lifeline" data-entity-uid="part2" data-qualified-name="Controller" id="part2-lifeline"><g><title>PortfolioRestController</title><rect fill="#000000" fill-opacity="0.00000" height="696.3828" width="8" x="344.2168" y="82.2969"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:5,5;" x1="348.0225" x2="348.0225" y1="82.2969" y2="778.6797"/></g></g><g class="participant-lifeline" data-entity-uid="part3" data-qualified-name="Service" id="part3-lifeline"><g><title>PortfolioStockOperationsService</title><rect fill="#000000" fill-opacity="0.00000" height="696.3828" width="8" x="588.2798" y="82.2969"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:5,5;" x1="591.5073" x2="591.5073" y1="82.2969" y2="778.6797"/></g></g><g class="participant-lifeline" data-entity-uid="part4" data-qualified-name="Portfolio" id="part4-lifeline"><g><title>Portfolio</title><rect fill="#000000" fill-opacity="0.00000" height="696.3828" width="8" x="774.0981" y="82.2969"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:5,5;" x1="778.0522" x2="778.0522" y1="82.2969" y2="778.6797"/></g></g><g class="participant-lifeline" data-entity-uid="part5" data-qualified-name="Handler" id="part5-lifeline"><g><title>GlobalExceptionHandler</title><rect fill="#000000" fill-opacity="0.00000" height="696.3828" width="8" x="931.6089" y="82.2969"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:5,5;" x1="935.144" x2="935.144" y1="82.2969" y2="778.6797"/></g></g><g class="participant participant-head" data-entity-uid="part1" data-qualified-name="Client" id="part1-head"><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="40.5303" x="46" y="78.9951">Client</text><ellipse cx="69.2651" cy="14" fill="#FFFFFF" rx="8" ry="8" style="stroke:#000000;stroke-width:1;"/><path d="M69.2651,22 L69.2651,49 M56.2651,30 L82.2651,30 M69.2651,49 L56.2651,64 M69.2651,49 L82.2651,64" fill="none" style="stroke:#000000;stroke-width:1;"/></g><g class="participant participant-tail" data-entity-uid="part1" data-qualified-name="Client" id="part1-tail"><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="40.5303" x="46" y="790.6748">Client</text><ellipse cx="69.2651" cy="802.9766" fill="#FFFFFF" rx="8" ry="8" style="stroke:#000000;stroke-width:1;"/><path d="M69.2651,810.9766 L69.2651,837.9766 M56.2651,818.9766 L82.2651,818.9766 M69.2651,837.9766 L56.2651,852.9766 M69.2651,837.9766 L82.2651,852.9766" fill="none" style="stroke:#000000;stroke-width:1;"/></g><g class="participant participant-head" data-entity-uid="part2" data-qualified-name="Controller" id="part2-head"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="172.3887" x="262.0225" y="51"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="158.3887" x="269.0225" y="70.9951">PortfolioRestController</text></g><g class="participant participant-tail" data-entity-uid="part2" data-qualified-name="Controller" id="part2-tail"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="172.3887" x="262.0225" y="777.6797"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="158.3887" x="269.0225" y="797.6748">PortfolioRestController</text></g><g class="participant participant-head" data-entity-uid="part3" data-qualified-name="Service" id="part3-head"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="239.5449" x="472.5073" y="51"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="225.5449" x="479.5073" y="70.9951">PortfolioStockOperationsService</text></g><g class="participant participant-tail" data-entity-uid="part3" data-qualified-name="Service" id="part3-tail"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="239.5449" x="472.5073" y="777.6797"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="225.5449" x="479.5073" y="797.6748">PortfolioStockOperationsService</text></g><g class="participant participant-head" data-entity-uid="part4" data-qualified-name="Portfolio" id="part4-head"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="72.0918" x="742.0522" y="51"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="58.0918" x="749.0522" y="70.9951">Portfolio</text></g><g class="participant participant-tail" data-entity-uid="part4" data-qualified-name="Portfolio" id="part4-tail"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="72.0918" x="742.0522" y="777.6797"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="58.0918" x="749.0522" y="797.6748">Portfolio</text></g><g class="participant participant-head" data-entity-uid="part5" data-qualified-name="Handler" id="part5-head"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="182.9297" x="844.144" y="51"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="168.9297" x="851.144" y="70.9951">GlobalExceptionHandler</text></g><g class="participant participant-tail" data-entity-uid="part5" data-qualified-name="Handler" id="part5-tail"><rect fill="#FFFFFF" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1;" width="182.9297" x="844.144" y="777.6797"/><text fill="#000000" font-family="Verdana" font-size="14" lengthAdjust="spacing" textLength="168.9297" x="851.144" y="797.6748">GlobalExceptionHandler</text></g><g><title>PortfolioRestController</title><rect fill="#FFFFFF" height="521.3203" style="stroke:#000000;stroke-width:1;" width="10" x="343.2168" y="128.5625"/></g><g><title>GlobalExceptionHandler</title><rect fill="#FFFFFF" height="116.6641" style="stroke:#000000;stroke-width:1;" width="10" x="930.6089" y="428.4219"/></g><g class="message" data-entity-1="part1" data-entity-2="part2" id="msg1"><polygon fill="#000000" points="331.2168,124.5625,341.2168,128.5625,331.2168,132.5625,335.2168,128.5625" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="69.2651" x2="337.2168" y1="128.5625" y2="128.5625"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="222.8662" x="76.2651" y="108.3638">POST /api/portfolios/abc-123/sales</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="201.5063" x="76.2651" y="123.4966">{"ticker":"AAPL", "quantity":0}</text></g><g class="message" data-entity-1="part2" data-entity-2="part2" id="msg2"><line style="stroke:#000000;stroke-width:1;" x1="353.2168" x2="395.2168" y1="203.0938" y2="203.0938"/><line style="stroke:#000000;stroke-width:1;" x1="395.2168" x2="395.2168" y1="203.0938" y2="216.0938"/><line style="stroke:#000000;stroke-width:1;" x1="354.2168" x2="395.2168" y1="216.0938" y2="216.0938"/><polygon fill="#000000" points="364.2168,212.0938,354.2168,216.0938,364.2168,220.0938,360.2168,216.0938" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="141.9463" x="360.2168" y="152.6294">Create Value Objects:</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="157.6631" x="360.2168" y="167.7622">PortfolioId.of("abc-123")</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="111.2046" x="360.2168" y="182.895">Ticker.of("AAPL")</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="167.5146" x="360.2168" y="198.0278">ShareQuantity.positive(0)</text></g><path d="M358,229.0938 L358,344.0938 L601,344.0938 L601,239.0938 L591,229.0938 L358,229.0938" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M591,229.0938 L591,239.0938 L601,239.0938 L591,229.0938" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="130.749" x="364" y="246.1606">Defense in depth:</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="167.5146" x="364" y="261.2935">ShareQuantity.positive(0)</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="211.7642" x="364" y="276.4263">throws InvalidQuantityException</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="163.7441" x="364" y="291.5591">at the adapter boundary.</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="4.1323" x="364" y="306.6919">&#160;</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="209.0347" x="364" y="321.8247">Even if bypassed, Portfolio.sell()</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="222.7012" x="364" y="336.9575">checks quantity.isPositive() again.</text><g class="message" data-entity-1="part2" data-entity-2="part2" id="msg3"><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="353.2168" x2="395.2168" y1="386.2891" y2="386.2891"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="395.2168" x2="395.2168" y1="386.2891" y2="399.2891"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="354.2168" x2="395.2168" y1="399.2891" y2="399.2891"/><polygon fill="#000000" points="364.2168,395.2891,354.2168,399.2891,364.2168,403.2891,360.2168,399.2891" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="210.063" x="360.2168" y="366.0903">throw InvalidQuantityException(</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="202.4014" x="360.2168" y="381.2231">"Quantity must be positive: 0")</text></g><g class="message" data-entity-1="part2" data-entity-2="part5" id="msg4"><polygon fill="#000000" points="918.6089,424.4219,928.6089,428.4219,918.6089,432.4219,922.6089,428.4219" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;" x1="353.2168" x2="924.6089" y1="428.4219" y2="428.4219"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="112.4297" x="360.2168" y="423.356">handle exception</text></g><g class="message" data-entity-1="part5" data-entity-2="part5" id="msg5"><line style="stroke:#000000;stroke-width:1;" x1="940.6089" x2="982.6089" y1="502.9531" y2="502.9531"/><line style="stroke:#000000;stroke-width:1;" x1="982.6089" x2="982.6089" y1="502.9531" y2="515.9531"/><line style="stroke:#000000;stroke-width:1;" x1="941.6089" x2="982.6089" y1="515.9531" y2="515.9531"/><polygon fill="#000000" points="951.6089,511.9531,941.6089,515.9531,951.6089,519.9531,947.6089,515.9531" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="142.0225" x="947.6089" y="452.4888">create ProblemDetail:</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="82.0942" x="947.6089" y="467.6216">- status: 400</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="158.228" x="947.6089" y="482.7544">- title: "Invalid Quantity"</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="234.4189" x="947.6089" y="497.8872">- detail: "Quantity must be positive"</text></g><g class="message" data-entity-1="part5" data-entity-2="part2" id="msg6"><polygon fill="#000000" points="364.2168,541.0859,354.2168,545.0859,364.2168,549.0859,360.2168,545.0859" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="358.2168" x2="934.6089" y1="545.0859" y2="545.0859"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="214.7158" x="370.2168" y="540.02">ResponseEntity&lt;ProblemDetail&gt;</text></g><g class="message" data-entity-1="part2" data-entity-2="part1" id="msg7"><polygon fill="#000000" points="80.2651,645.8828,70.2651,649.8828,80.2651,653.8828,76.2651,649.8828" style="stroke:#000000;stroke-width:1;"/><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2,2;" x1="74.2651" x2="347.2168" y1="649.8828" y2="649.8828"/><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="159.9292" x="86.2651" y="569.1528">HTTP 400 BAD REQUEST</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="8.271" x="86.2651" y="584.2856">{</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="165.4961" x="94.5298" y="599.4185">"title": "Invalid Quantity",</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="241.687" x="94.5298" y="614.5513">"detail": "Quantity must be positive",</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="85.23" x="94.5298" y="629.6841">"status": 400</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="8.271" x="86.2651" y="644.8169">}</text></g><path d="M10,662.8828 L10,762.8828 L996,762.8828 L996,672.8828 L986,662.8828 L10,662.8828" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><path d="M986,662.8828 L986,672.8828 L996,672.8828 L986,662.8828" fill="#FFFFFF" style="stroke:#000000;stroke-width:1;"/><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="242.3979" x="349.9636" y="679.9497">Domain Exception &#8594; HTTP Status</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="294.3535" x="349.9636" y="695.0825">InvalidQuantityException &#8594; 400 Bad Request</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="4.1323" x="349.9636" y="710.2153">&#160;</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="111.4902" x="349.9636" y="725.3481">The Value Object</text><text fill="#000000" font-family="Verdana" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="181.5239" x="465.5862" y="725.3481">ShareQuantity.positive()</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="253.0176" x="349.9636" y="740.481">enforces this rule at construction time.</text><text fill="#000000" font-family="Verdana" font-size="13" lengthAdjust="spacing" textLength="259.1367" x="349.9636" y="755.6138">Portfolio.sell() provides a second guard.</text><?plantuml-src VLJ9Rjim4BthAwRinJOSsrrEGX4WTTmcG84uiTkJBvGujbZJf49IReCYrtv0Fx5VqX6rU6bLs8SXESkRcVVqmcUuGyWLbpfoMwbpRlaE4fvkDzOKMaoDCXPUVfYLloZYgQVZL4dKFY9VBrEPS-s1pOtrQwEaUK3dfqPxQvH2ou0xE1mxOXRUfDkx72ttqcYtGBkNAOROsku832xjwTJfep89LxFlAUPbrXkkHGEejgEewWGkBeymnZ2_MonXp7CvpflKRioJzEBLwpTZnnMwbVx1gDAMyiNiwch-YGs1FHPKL_ed5a-Uoqd9FVTut7nqiCzBJYsMpb-uAX3kag-OUXUlTDlQhHYPTO_L85X_fPUXVBWD0EXgaN6BzpMAKMwS90pOc_IZI1lARkKcys3MnvW01eDhNADs25A3e65byM10zztP07ncpJS7jthFbHIDKpjhyk2Ud12uuBcdTfEIJDm-ZUY9_hCzQf1hI9voxXoAuM698uTAzSeYQORfra4prf5qymP47_Y6A3kAK0ieUpkTxTbm0zfEiBsLPiqbx0hd8I55r9LYcB3--U9g-iIG1GEmxRlTUikmsZW9Iwjbpwr95EwkqNEfQDaNu3ptXOlXxMHI7WcH8WIiHWuDIbO-YYeCkh6pe-fd4o6HvYGqd8N8ToT8BYE1V_TnFjuWd1Xkbijv2HVUNrt3m-p-yson976iD00ByDc_y0_3UzK1-syBbMSr5rOFvlaOuB6y0idD7filrB257rXkTaGPQFSElt_-gl0lGlf0-YwI1EVG9nSqlSU2ld8LbPVPgMofKeTo-g42whMnAJfYfNHW2-8FQIMbRNXRfA6MbpiiXNAk2SYjsKj1iHmSKeY0JS6jECZW3m00?></g></svg>