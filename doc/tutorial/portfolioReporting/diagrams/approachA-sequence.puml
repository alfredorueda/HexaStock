@startuml approachA-sequence
!theme plain
skinparam backgroundColor #FEFEFE

title Approach A — Single-Pass In-Memory Aggregation (Current Implementation)

participant "PortfolioRestController\n(Driving Adapter)" as Controller
participant "ReportingService\n(Application Service)" as Service
participant "PortfolioPort\n(Secondary Port)" as PortfolioPort
participant "TransactionPort\n(Secondary Port)" as TransactionPort
participant "StockPriceProviderPort\n(Secondary Port)" as PricePort
participant "HoldingPerformanceCalculator\n(Domain Service)" as Calculator

activate Controller
Controller -> Service: getHoldingsPerfomance(portfolioId)
activate Service

note right of Service
  **Application layer orchestration**
  No business logic here —
  only coordination of ports
  and domain services.
end note

== 1. Load aggregate ==
Service -> PortfolioPort: getPortfolioById(PortfolioId)
activate PortfolioPort
PortfolioPort --> Service: Optional<Portfolio>
deactivate PortfolioPort
Service -> Service: portfolio.orElseThrow()

== 2. Load full transaction list ==
Service -> TransactionPort: getTransactionsByPortfolioId(PortfolioId)
activate TransactionPort
TransactionPort --> Service: List<Transaction>  ← all T transactions
deactivate TransactionPort

== 3. Fetch live prices (sequential — free-tier rate limit) ==
Service -> PricePort: fetchStockPrice(Set<Ticker>)
activate PricePort
note right of PricePort
  Iterates tickers one by one.
  Sequential to respect API rate limits.
end note
PricePort --> Service: Map<Ticker, StockPrice>
deactivate PricePort

== 4. Domain computation — O(T) single pass ==
Service -> Calculator: getHoldingsPerformance(\n  portfolio, transactions, tickerPrices)
activate Calculator

note right of Calculator
  **Single-pass loop over T transactions**
  • HashMap<Ticker, TickerAccumulator>
  • switch (tx.getType()) { PURCHASE → ..., SALE → ... }
  • No parallelStream, no repeated filtering
  • O(T) time, O(H) memory (H = distinct tickers)
  • Returns List.copyOf(results) — immutable
end note

Calculator --> Service: List<HoldingDTO>  (immutable)
deactivate Calculator

Service --> Controller: List<HoldingDTO>
deactivate Service
Controller --> : HTTP 200 JSON
deactivate Controller
@enduml
